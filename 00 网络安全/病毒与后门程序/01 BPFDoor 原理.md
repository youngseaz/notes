


# å‰ç½®çŸ¥è¯†


## BPF

### BPF ç®€ä»‹
Berkeley Packet Filter (BPF) æœ€æ—©ç‰ˆæœ¬çš„ BPF æ˜¯ 1990 å¹´ä»£ç”± Berkeley å¤§å­¦å¼€å‘ï¼Œç”¨äºé«˜æ•ˆåœ°ä»ç½‘ç»œæ¥å£ä¸­æŠ“åŒ…ï¼Œä¸»è¦ç”¨äºå·¥å…·å¦‚ tcpdump.

extended BPF (eBPF) æ˜¯ BPF çš„ç°ä»£å¢å¼ºç‰ˆï¼ŒåŠŸèƒ½å¤§å¹…æ‰©å±•ï¼Œæ—©å·²è¶…è¶ŠåŸå§‹çš„ç½‘ç»œåŒ…è¿‡æ»¤ç”¨é€”ã€‚eBPF å…¼å®¹ BPF.

| ç‰¹æ€§     | BPFï¼ˆç»å…¸ BPFï¼‰       | eBPFï¼ˆæ‰©å±• BPFï¼‰                         |
| ------ | ----------------- | ------------------------------------ |
| æœ€åˆç”¨é€”   | æŠ“åŒ…è¿‡æ»¤ï¼ˆå¦‚ `tcpdump`ï¼‰ | å†…æ ¸çº§ç¼–ç¨‹å¹³å°ï¼ˆç½‘ç»œã€å®‰å…¨ã€è¿½è¸ªã€ç›‘æ§ç­‰ï¼‰                |
| æŒ‡ä»¤é›†    | ç®€å•ã€å°‘æ•°æŒ‡ä»¤           | ä¸°å¯Œã€æ”¯æŒè°ƒç”¨ helper å‡½æ•°ã€æ›´å¤šå¯„å­˜å™¨              |
| ç¨‹åºå¤§å°é™åˆ¶ | å¾ˆå°ï¼ˆ\~4096 å­—èŠ‚ï¼‰     | æ›´å¤§ï¼ˆ\~1Mï¼‰ï¼Œå…è®¸å¤æ‚é€»è¾‘                      |
| æ‰§è¡Œä¸Šä¸‹æ–‡  | ç½‘ç»œåŒ…æ•è·             | å†…æ ¸æŒ‚é’©ï¼ˆkprobeã€tracepointã€XDPã€LSM ç­‰ï¼‰    |
| å®‰å…¨æœºåˆ¶   | æ—                  | æœ‰ï¼šVerifier æ ¡éªŒç¨‹åºå®‰å…¨æ€§                   |
| ç¼–ç¨‹è¯­è¨€æ”¯æŒ | æ±‡ç¼–                | Cï¼ˆé€šè¿‡ LLVMï¼‰ã€bpftraceã€Pythonï¼ˆbccï¼‰ç­‰     |
| å†…æ ¸é›†æˆç¨‹åº¦ | è¾ƒä½                | é«˜åº¦é›†æˆï¼Œå¯ä¸å¤šç§å†…æ ¸å­ç³»ç»Ÿé…åˆ                     |
| æ•°æ®äº¤äº’   | æ—  mapã€å…±äº«æ•°æ®æœºåˆ¶      | æœ‰ mapã€ringbufã€perf buffer ç­‰ä¸ç”¨æˆ·ç©ºé—´äº¤äº’æœºåˆ¶ |
| çŠ¶æ€ç®¡ç†   | æ—                  | æ”¯æŒæŒä¹…çŠ¶æ€ï¼ˆé€šè¿‡ BPF mapï¼‰                   |


### BPF åŸç†

[BPF document](https://docs.kernel.org/bpf/)
cBPFï¼ˆClassic BPFï¼‰æ¶æ„éå¸¸ç®€æ´ï¼Œåªæœ‰ 2 ä¸ª 32 ä½å¯„å­˜å™¨ï¼š

å¯„å­˜å™¨	åç§°	ä½œç”¨
A	Accumulatorï¼ˆç´¯åŠ å™¨ï¼‰	æ‰€æœ‰ç®—æœ¯è¿ç®—ã€æ¯”è¾ƒã€åŠ è½½/å­˜å‚¨æ“ä½œä¸»è¦åœ¨è¿™ä¸ªå¯„å­˜å™¨ä¸Šè¿›è¡Œ
X	Index Registerï¼ˆç´¢å¼•å¯„å­˜å™¨ï¼‰	ä½œä¸ºè¾…åŠ©å¯„å­˜å™¨ï¼Œç”¨äºç´¢å¼•è®¿é—®ã€éƒ¨åˆ†ç®—æœ¯è¿ç®—ã€æ¡ä»¶è·³è½¬ç­‰

### BPF åº”ç”¨

Classic BPFï¼ˆcBPFï¼‰ä»£ç ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ª Linux åŸå§‹å¥—æ¥å­—çš„ BPF æ•°æ®åŒ…è¿‡æ»¤å™¨
```c
struct sock_filter {
    __u16 code; // æ“ä½œç ï¼ˆæŒ‡ä»¤ï¼‰
    __u8 jt;    // æ¡ä»¶è·³è½¬æˆåŠŸæ—¶è·³å‡ æ¡
    __u8 jf;    // æ¡ä»¶è·³è½¬å¤±è´¥æ—¶è·³å‡ æ¡
    __u32 k;    // å¸¸æ•°å‚æ•°
};
```


## IP åˆ†ç‰‡

å½“ IP åŒ…å¤§å°è¶…è¿‡è·¯å¾„æŸæ®µé“¾è·¯çš„æœ€å¤§ä¼ è¾“å•å…ƒ (max transmission unit, MTU) ä¸”å…è®¸åˆ†ç‰‡ï¼ˆDF=0ï¼‰æ—¶ï¼ŒIP å±‚å°±ä¼šè¿›è¡Œåˆ†ç‰‡ã€‚

IP åˆ†ç‰‡ï¼ˆFragmentationï¼‰ æ˜¯æŒ‡ï¼šå½“ä¸€ä¸ª IP åŒ…çš„å¤§å°ï¼ˆæ€»é•¿åº¦ï¼‰è¶…è¿‡äº†æ²¿é€”æŸæ®µé“¾è·¯çš„ MTUï¼ˆæœ€å¤§ä¼ è¾“å•å…ƒï¼‰ï¼Œå°±å¿…é¡»å°†è¿™ä¸ªåŒ…æ‹†æˆå¤šä¸ªç¢ç‰‡ä¼ è¾“ï¼Œä»¥é€‚åº”é“¾è·¯çš„æœ€å¤§åŒ…é•¿é™åˆ¶ã€‚

IP æ•°æ®åŒ…ä¼šåœ¨æ»¡è¶³ ä»¥ä¸‹æƒ…å†µæ—¶å‘ç”Ÿåˆ†ç‰‡ï¼ˆFragmentationï¼‰ï¼š

ğŸš§ äºŒã€ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘ IP åˆ†ç‰‡ï¼Ÿ
- æ¡ä»¶ 1ï¼šIP æ•°æ®åŒ…é•¿åº¦ > è·¯å¾„ä¸Šçš„æŸä¸ª MTUï¼Œå¸¸è§ MTUï¼šä»¥å¤ªç½‘é»˜è®¤æ˜¯ 1500 å­—èŠ‚ï¼›
- æ¡ä»¶ 2ï¼šè¯¥ IP åŒ…å…è®¸åˆ†ç‰‡ï¼ˆDon't Fragment = 0ï¼‰ã€‚IP æŠ¥æ–‡å¤´ä¸­çš„ Flags å­—æ®µæœ‰ä¸€ä½å« DFï¼ˆDon't Fragmentï¼‰ï¼š
```
Flag ä½	å«ä¹‰
DF = 1	ä¸å…è®¸åˆ†ç‰‡ï¼Œè‹¥ä¸èƒ½ä¼ å°±ä¸¢å¼ƒå¹¶å› ICMP
DF = 0	å¯ä»¥åˆ†ç‰‡
```
è¦è§¦å‘çœŸæ­£çš„â€œIP åˆ†ç‰‡â€ï¼Œä¸¤ä¸ªæ¡ä»¶éƒ½è¦æ»¡è¶³ï¼šIPåŒ…é•¿åº¦ > MTU ä¸” DF=0
ğŸ§ª ä¸‰ã€åˆ†ç‰‡å­—æ®µï¼ˆIPå¤´ï¼‰
åˆ†ç‰‡æ—¶ï¼ŒIP åŒ…å¤´çš„è¿™å‡ ä¸ªå­—æ®µç‰¹åˆ«å…³é”®ï¼š

å­—æ®µå|å«ä¹‰
-|-
Identification	| æ‰€æœ‰åˆ†ç‰‡æœ‰ç›¸åŒçš„ IDï¼Œç”¨äºé‡ç»„
Fragment Offset	| åˆ†ç‰‡åç§»é‡ï¼ˆå•ä½ä¸º 8 å­—èŠ‚ï¼‰
MFï¼ˆMore Fragmentsï¼‰|	é™¤æœ€åä¸€ä¸ªåˆ†ç‰‡å¤–éƒ½è®¾ä¸º 1ï¼Œæœ€åä¸€ä¸ªä¸º 0
DFï¼ˆDon't Fragmentï¼‰|	è®¾ç½®ä¸º 1 æ—¶ä¸å…è®¸åˆ†ç‰‡

![alt text](<images/01 BPFDoor åŸç†/image-2.png>)

### IP åˆ†ç‰‡å®‰å…¨é—®é¢˜

æ”»å‡»è€…å¯èƒ½åˆ©ç”¨åˆ†ç‰‡ï¼š
- ç»•è¿‡é˜²ç«å¢™ï¼ˆIPåˆ†ç‰‡é‡ç»„åçš„ payload è¢«åˆ†æ•£ï¼‰
- æ„é€  overlapping fragments â†’ è§¦å‘åè®®å®ç°æ¼æ´ï¼ˆTeardrop æ”»å‡»ï¼‰
- BPFDoor ç±»æœ¨é©¬ä½¿ç”¨åˆ†ç‰‡åŒ…ç»•è¿‡è¿‡æ»¤å™¨

# BPFDoor è¯¦ç»†è§£æ

- [BPF Instruction Set Architecture](https://www.kernel.org/doc/html/latest/bpf/standardization/instruction-set.html)
- [bpfdoor source code - github](https://github.com/gwillgues/BPFDoor/blob/main/bpfdoor.c)

```c
struct sock_filter bpf_code[] = {
                { 0x28, 0, 0, 0x0000000c },   // 01 ldh[12], åŠ è½½ä»¥å¤ªç½‘å¸§ç¬¬ 12 å­—èŠ‚å¼€å§‹çš„ 2 å­—èŠ‚å†…å®¹ï¼Œä¹Ÿå°±æ˜¯ EtherTypeã€‚
                { 0x15, 0, 27, 0x00000800 },  // 02 jeq #0x0800, jt=0, jf=27
                { 0x30, 0, 0, 0x00000017 },   // 03 ldb [23] åŠ è½½ IP æ•°æ®åŒ…ç¬¬ 23 å­—èŠ‚ï¼Œå³ åè®®å­—æ®µï¼ˆprotocolï¼‰
                { 0x15, 0, 5, 0x00000011 },   // 04 jeq #17, jt=0, jf=5 åˆ¤æ–­åè®®æ˜¯å¦ä¸º 0x11 â†’ UDPã€‚ä¸æ˜¯å°±è·³ 5 æ¡ï¼ˆä¸¢å¼ƒè¯¥è·¯å¾„ï¼‰ã€‚
                { 0x28, 0, 0, 0x00000014 },   // 05 ldh [20] ä» IP æ•°æ®å¼€å§‹ç¬¬ 20 å­—èŠ‚è¯» 2 å­—èŠ‚ â†’ å³ IP flags/fragment offset å­—æ®µã€‚
                { 0x45, 23, 0, 0x00001fff },  // 06 jset #0x1fff, jt=23, jf=0 åˆ¤æ–­æ˜¯å¦æ˜¯åˆ†ç‰‡åŒ…ï¼ˆä½ 13 ä½ä¸ä¸º 0 è¡¨ç¤ºæ˜¯åˆ†ç‰‡åŒ…ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œå°±è·³è½¬ 23ï¼ˆä¸¢å¼ƒï¼‰ã€‚
                { 0xb1, 0, 0, 0x0000000e },   // 07 ldh [22] ä»UDPå¤´éƒ¨å–æºç«¯å£ï¼ˆä»¥å¤ªç½‘å¤´14å­—èŠ‚+IPå¤´é•¿åº¦Xï¼Œ22åç§»æ˜¯UDPæºç«¯å£ä½ç½®ï¼‰
                { 0x48, 0, 0, 0x00000016 },   // 08 jeq #29269 
                { 0x15, 19, 20, 0x00007255 }, // 09
                { 0x15, 0, 7, 0x00000001 },   // 10
                { 0x28, 0, 0, 0x00000014 },   // 11
                { 0x45, 17, 0, 0x00001fff },  // 12
                { 0xb1, 0, 0, 0x0000000e },   // 13
                { 0x48, 0, 0, 0x00000016 },   // 14
                { 0x15, 0, 14, 0x00007255 },  // 15
                { 0x50, 0, 0, 0x0000000e },   // 16
                { 0x15, 11, 12, 0x00000008 }, // 17
                { 0x15, 0, 11, 0x00000006 },  // 18
                { 0x28, 0, 0, 0x00000014 },   // 19
                { 0x45, 9, 0, 0x00001fff },   // 20
                { 0xb1, 0, 0, 0x0000000e },   // 21
                { 0x50, 0, 0, 0x0000001a },   // 22
                { 0x54, 0, 0, 0x000000f0 },   // 23
                { 0x74, 0, 0, 0x00000002 },   // 24
                { 0xc, 0, 0, 0x00000000 },    // 25
                { 0x7, 0, 0, 0x00000000 },    // 26
                { 0x48, 0, 0, 0x0000000e },   // 27
                { 0x15, 0, 1, 0x00005293 },   // 28
                { 0x6, 0, 0, 0x0000ffff },    // 29
                { 0x6, 0, 0, 0x00000000 },    // 30 
        };
```


![alt text](<images/01 BPFDoor åŸç†/image.png>)

![alt text](<images/01 BPFDoor åŸç†/image-1.png>)
